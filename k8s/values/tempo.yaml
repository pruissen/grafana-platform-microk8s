# k8s/values/tempo.yaml
# Chart: grafana/tempo | Version: 1.24.1 (App: 2.9.0)

tempo:
  # ---------------------------------------------------------------------
  # 1. MULTITENANCY & REPORTING
  # ---------------------------------------------------------------------
  # Enable multi-tenancy so Tempo creates tenant-specific blocks in MinIO.
  # This also ensures X-Scope-OrgID headers are forwarded to Mimir automatically.
  multitenancyEnabled: true
  reportingEnabled: false

  # ---------------------------------------------------------------------
  # 2. METRICS GENERATOR
  # ---------------------------------------------------------------------
  # We use the chart's built-in mechanism. Tempo automatically forwards
  # the 'X-Scope-OrgID' from the trace to the Mimir write request.
  metricsGenerator:
    enabled: true
    remoteWriteUrl: "http://mimir-nginx.observability-prd.svc:80/api/v1/push"

  # ---------------------------------------------------------------------
  # 3. STORAGE (MinIO/S3)
  # ---------------------------------------------------------------------
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-data
        # MinIO endpoint within the cluster
        endpoint: loki-minio.observability-prd.svc:9000
        # insecure: true is required for internal HTTP MinIO
        insecure: true
        # forcepathstyle: true is required for MinIO
        forcepathstyle: true
      wal:
        path: /var/tempo/wal

  # ---------------------------------------------------------------------
  # 4. CREDENTIALS (⚠️ CRITICAL FIX: MUST BE NESTED UNDER 'tempo')
  # ---------------------------------------------------------------------
  # This injects AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY env vars
  # which the MinIO/S3 client automatically detects.
  extraEnvFrom:
    - secretRef:
        name: tempo-s3-credentials

  # ---------------------------------------------------------------------
  # 5. RESOURCES & PROBES
  # ---------------------------------------------------------------------
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      memory: 1Gi

  # Increase timeouts to allow Tempo time to initialize the Ring
  livenessProbe:
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  # ---------------------------------------------------------------------
  # 6. SERVER CONFIG
  # ---------------------------------------------------------------------
  server:
    http_listen_port: 3200

  # ---------------------------------------------------------------------
  # 7. OVERRIDES (Processors)
  # ---------------------------------------------------------------------
  overrides:
    defaults:
      metrics_generator:
        processors:
          - service-graphs
          - span-metrics