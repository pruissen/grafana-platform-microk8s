# k8s/values/tempo.yaml
# Chart: grafana/tempo | Version: 1.24.1 (App: 2.9.0)

tempo:
  # ---------------------------------------------------------------------
  # 1. MULTITENANCY & METRICS GENERATOR
  # ---------------------------------------------------------------------
  multitenancyEnabled: true
  
  metricsGenerator:
    enabled: true
    # Points to Mimir's Distributor
    remoteWriteUrl: "http://mimir-nginx.observability-prd.svc:80/api/v1/push"

  # ---------------------------------------------------------------------
  # 2. CONFIGURATION OVERRIDES
  # ---------------------------------------------------------------------
  overrides:
    defaults:
      metrics_generator:
        processors:
          - service-graphs
          - span-metrics

  # ---------------------------------------------------------------------
  # 3. STORAGE (S3 / MinIO)
  # ---------------------------------------------------------------------
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-data
        # ✅ FIXED 1: No 'http://' prefix allowed by MinIO client
        endpoint: loki-minio.observability-prd.svc:9000
        # ✅ FIXED 2: 'insecure: true' tells the client to use HTTP (instead of HTTPS)
        insecure: true
        # ✅ FIXED 3: 'forcepathstyle' (lowercase, no underscore) fixes the DNS bucket resolution
        forcepathstyle: true
      wal:
        path: /var/tempo/wal

  # # ---------------------------------------------------------------------
  # # 4. SERVER & PROTOCOLS
  # # ---------------------------------------------------------------------
  # server:
  #   http_listen_port: 3200
  #   grpc_listen_port: 9095

  # ---------------------------------------------------------------------
  # 5. CREDENTIALS (Nested Safety)
  # ---------------------------------------------------------------------
  extraEnvFrom:
    - secretRef:
        name: tempo-s3-credentials

  # ---------------------------------------------------------------------
  # 6. PROBES (Startup Stability Fix)
  # ---------------------------------------------------------------------
  # Tempo 2.9+ Compactor Ring initialization takes ~60s.
  # We MUST wait longer than that, or K8s will kill the pod before it starts.
  livenessProbe:
    initialDelaySeconds: 120  # increased to 2 minutes to be safe
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  # ---------------------------------------------------------------------
  # 7. RESOURCES
  # ---------------------------------------------------------------------
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 512Mi

# -----------------------------------------------------------------------
# 8. CREDENTIALS INJECTION (Root Level)
# -----------------------------------------------------------------------
extraEnvFrom:
  - secretRef:
      name: tempo-s3-credentials