# k8s/values/tempo.yaml
# Chart: grafana/tempo | Version: 1.24.1 (App: 2.9.0)

tempo:
  # ---------------------------------------------------------------------
  # 1. MULTITENANCY & METRICS GENERATOR
  # ---------------------------------------------------------------------
  multitenancyEnabled: true
  
  # âœ… FIXED: Use full config structure to inject headers
  metricsGenerator:
    enabled: true
    config:
      storage:
        remote_write:
          - url: "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
            headers:
              X-Scope-OrgID: "devteam-1" # ðŸ‘ˆ Required for Mimir Auth
            send_exemplars: true

  # ---------------------------------------------------------------------
  # 2. CONFIGURATION OVERRIDES
  # ---------------------------------------------------------------------
  overrides:
    defaults:
      metrics_generator:
        processors:
          - service-graphs  # <--- Generates Node Graph data
          - span-metrics    # <--- Generates RED metrics (Rate, Error, Duration)

  # ---------------------------------------------------------------------
  # 3. STORAGE (S3 / MinIO)
  # ---------------------------------------------------------------------
  storage:
    trace:
      backend: s3
      s3:
        bucket: tempo-data
        # âœ… FIXED 1: No 'http://' prefix allowed by MinIO client
        endpoint: loki-minio.observability-prd.svc:9000
        # âœ… FIXED 2: 'insecure: true' tells the client to use HTTP (instead of HTTPS)
        insecure: true
        # âœ… FIXED 3: 'forcepathstyle' (lowercase, no underscore) fixes the DNS bucket resolution
        forcepathstyle: true
      wal:
        path: /var/tempo/wal

  # ---------------------------------------------------------------------
  # 5. CREDENTIALS (Nested Safety)
  # ---------------------------------------------------------------------
  extraEnvFrom:
    - secretRef:
        name: tempo-s3-credentials

  # ---------------------------------------------------------------------
  # 6. PROBES (Startup Stability Fix)
  # ---------------------------------------------------------------------
  # Tempo 2.9+ Compactor Ring initialization takes ~60s.
  livenessProbe:
    initialDelaySeconds: 120
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

  # ---------------------------------------------------------------------
  # 7. RESOURCES
  # ---------------------------------------------------------------------
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 512Mi

# -----------------------------------------------------------------------
# 8. CREDENTIALS INJECTION (Root Level)
# -----------------------------------------------------------------------
extraEnvFrom:
  - secretRef:
      name: tempo-s3-credentials