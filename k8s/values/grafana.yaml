# k8s/values/grafana.yaml
# Chart: grafana (v8.5.1)

admin:
  existingSecret: "grafana-admin-creds"
  userKey: admin-user
  passwordKey: admin-password

# Laptop Sizing
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    memory: 512Mi

# Enable Sidecar for Dashboards
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
  datasources:
    enabled: true
    defaultDatasourceEnabled: false

# Datasource Configuration (With Multitenancy Headers)
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # 1. MIMIR (Prometheus)
      - name: Mimir
        type: prometheus
        uid: mimir
        # Pointing to Mimir Nginx Gateway
        url: http://mimir-mimir-distributed-nginx.observability-prd.svc:80/prometheus
        access: proxy
        isDefault: true
        jsonData:
          # ✅ Header Injection
          httpHeaderName1: "X-Scope-OrgID"
          timeInterval: "15s"
        secureJsonData:
          httpHeaderValue1: "tenant1"

      # 2. LOKI
      - name: Loki
        type: loki
        uid: loki
        # Pointing to Loki Gateway
        url: http://loki-gateway.observability-prd.svc:80
        access: proxy
        jsonData:
          # ✅ Header Injection
          httpHeaderName1: "X-Scope-OrgID"
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: "traceID=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"
        secureJsonData:
          httpHeaderValue1: "tenant1"

      # 3. TEMPO
      - name: Tempo
        type: tempo
        uid: tempo
        # Pointing to Tempo Query Frontend (Long name)
        url: http://tempo-tempo-distributed-query-frontend.observability-prd.svc:3200
        access: proxy
        basicAuth: false
        jsonData:
          # ✅ Header Injection
          httpHeaderName1: "X-Scope-OrgID"
          tracesToLogsV2:
            datasourceUid: 'loki'
            spanStartTimeShift: '1h'
            spanEndTimeShift: '-1h'
            tags: ['job', 'instance', 'pod', 'namespace']
            filterByTraceID: false
            filterBySpanID: false
            customQuery: true
            query: 'method="${__span.tags.method}"'
          tracesToMetrics:
            datasourceUid: 'mimir'
            spanStartTimeShift: '1h'
            spanEndTimeShift: '-1h'
            tags: [{ key: 'service.name', value: 'service' }, { key: 'job' }]
            queries:
              - name: 'Sample Rate'
                query: 'sum(rate(traces_spanmetrics_latency_bucket{$__tags}[5m]))'
          serviceMap:
            datasourceUid: 'mimir'
          nodeGraph:
            enabled: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: 'loki'
        secureJsonData:
          httpHeaderValue1: "tenant1"

# Service (ClusterIP only - No Ingress)
service:
  type: ClusterIP
  port: 80
  targetPort: 3000

ingress:
  enabled: false