# k8s/values/grafana.yaml
# Chart: grafana (v8.5.1)

admin:
  existingSecret: "grafana-admin-creds"
  userKey: admin-user
  passwordKey: admin-password

# Laptop Sizing
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    memory: 512Mi

# Enable Sidecar for Dashboards
sidecar:
  dashboards:
    enabled: true
    label: grafana_dashboard
  datasources:
    enabled: true
    defaultDatasourceEnabled: false

# Datasource Configuration (With Multitenancy Headers)
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # 1. MIMIR (Prometheus)
      - name: Mimir
        type: prometheus
        uid: mimir
        url: http://mimir-nginx.observability-prd.svc:80/prometheus
        access: proxy
        isDefault: true
        jsonData:
          httpHeaderName1: "X-Scope-OrgID"
          timeInterval: "15s"
        secureJsonData:
          httpHeaderValue1: "tenant1"

      # 2. LOKI
      - name: Loki
        type: loki
        uid: loki
        url: http://loki-gateway.observability-prd.svc:80
        access: proxy
        jsonData:
          httpHeaderName1: "X-Scope-OrgID"
          derivedFields:
            - datasourceUid: tempo
              matcherRegex: "traceID=(\\w+)"
              name: TraceID
              url: "$${__value.raw}"
        secureJsonData:
          httpHeaderValue1: "tenant1"

      # 3. TEMPO (Monolithic)
      - name: Tempo
        type: tempo
        uid: tempo
        url: http://tempo.observability-prd.svc:3100
        access: proxy
        basicAuth: false
        jsonData:
          httpHeaderName1: "X-Scope-OrgID"
          
          # ✅ LINK 1: Traces to Logs (Loki)
          tracesToLogsV2:
            datasourceUid: 'loki'
            spanStartTimeShift: '1h'
            spanEndTimeShift: '-1h'
            tags: ['job', 'instance', 'pod', 'namespace']
            filterByTraceID: false
            filterBySpanID: false
            customQuery: true
            query: 'method="${__span.tags.method}"'
          
          # ✅ LINK 2: Traces to Span Metrics (Mimir)
          tracesToMetrics:
            datasourceUid: 'mimir'
            spanStartTimeShift: '1h'
            spanEndTimeShift: '-1h'
            tags: [{ key: 'service.name', value: 'service' }, { key: 'job' }]
            queries:
              - name: 'Sample Rate'
                query: 'sum(rate(traces_spanmetrics_latency_bucket{$__tags}[5m]))'
          
          # ✅ LINK 3: Service Graph / Node Graph (Mimir)
          serviceMap:
            datasourceUid: 'mimir'
          nodeGraph:
            enabled: true
          
          # Search settings
          search:
            hide: false
          lokiSearch:
            datasourceUid: 'loki'
            
        secureJsonData:
          httpHeaderValue1: "tenant1"

# Service Configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 3000
  # ✅ ADDED: Annotations for Alloy/Prometheus discovery
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "3000"
    prometheus.io/path: "/metrics"

ingress:
  enabled: false