nameOverride: mimir

global:
  extraEnvFrom:
    - secretRef:
        name: mimir-s3-credentials

mimir:
  image:
    repository: public.ecr.aws/bitnami/grafana-mimir
    tag: latest

  structuredConfig:
    common:
      storage:
        backend: s3
        s3:
          endpoint: minio-enterprise.observability-prd.svc:9000
          insecure: true

    blocks_storage:
      backend: s3
      s3:
        bucket_name: mimir-blocks
        endpoint: minio-enterprise.observability-prd.svc:9000
        insecure: true
      tsdb:
        dir: /data/tsdb

    ruler_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: minio-enterprise.observability-prd.svc:9000
        insecure: true

    alertmanager_storage:
      backend: s3
      s3:
        bucket_name: mimir-ruler
        endpoint: minio-enterprise.observability-prd.svc:9000
        insecure: true
    
    usage_stats:
      enabled: false

    # --- REPLICATION FACTOR SETTINGS ---
    
    # 1. Ingester: CRITICAL FIX for "too many unhealthy instances"
    # Tells Mimir it's okay to only have 1 copy of the data.
    ingester:
      ring:
        replication_factor: 1
    
    # 2. Store Gateway: Good practice for single node
    store_gateway:
      sharding_ring:
        replication_factor: 1

    # 3. Distributor: Use memberlist for ring status
    distributor:
      ring:
        kvstore:
          store: memberlist

minio: { enabled: false }

# Kubernetes Replicas (Must match RF=1)
ingester:
  replicas: 1
  zoneAwareReplication: { enabled: false }
  affinity: null
  resources: { requests: { memory: 128Mi }, limits: { memory: 1Gi } }

store_gateway:
  replicas: 1
  zoneAwareReplication: { enabled: false }
  affinity: null
  resources: { requests: { memory: 128Mi }, limits: { memory: 1Gi } }

distributor: { replicas: 1, affinity: null }
querier: { replicas: 1, affinity: null }
query_frontend: { replicas: 1, affinity: null }
ruler: { replicas: 1, affinity: null }
compactor: { replicas: 1, affinity: null }
alertmanager: { replicas: 1, affinity: null, zoneAwareReplication: { enabled: false } }
overrides_exporter: { replicas: 1 }
rollout_operator: { enabled: true }
nginx: { enabled: true, replicas: 1 }