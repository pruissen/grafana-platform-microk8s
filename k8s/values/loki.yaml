# k8s/values/loki.yaml
# Architecture: Simple Scalable (Split Read/Write/Backend)
deploymentMode: SimpleScalable

global:
  extraEnvFrom:
    - secretRef:
        name: loki-s3-credentials

loki:
  auth_enabled: true

  # âœ… ENABLE FEDERATION (Querying multiple tenants via A|B)
  querier:
    multi_tenant_queries_enabled: true

  # âœ… INCREASE LIMITS (Standard configuration block)
  limits_config:
    max_query_series: 100000       # High limit for federation
    max_entries_limit_per_query: 10000
    cardinality_limit: 200000      # Prevents 500 Errors in Label Browser
    split_queries_by_interval: 15m # Performance optimization
    max_query_parallelism: 32
    volume_enabled: true

  commonConfig:
    replication_factor: 1
    ring:
      kvstore:
        store: memberlist

  # Storage Configuration (MinIO)
  storage:
    type: s3
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
      admin: loki-admin
    s3:
      endpoint: http://loki-minio.observability-prd.svc:9000
      s3ForcePathStyle: true
      insecure: true

  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: index_
          period: 24h

# --- ðŸš€ SCALABLE COMPONENTS (Laptop Optimized: 1 Replica) ---

# 1. WRITE TARGET (Ingestion)
write:
  replicas: 1
  persistence:
    size: 10Gi
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 2. READ TARGET (Querying)
read:
  replicas: 1
  persistence:
    size: 10Gi # Required for cache
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 3. BACKEND TARGET (Compaction/Rules)
backend:
  replicas: 1
  persistence:
    size: 10Gi
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 4. GATEWAY (Nginx)
gateway:
  replicas: 1
  ingress: { enabled: false }
  resources:
    requests: { cpu: 20m, memory: 64Mi }
    limits: { memory: 128Mi }
  
  # âœ… CRITICAL FIX: Prevent Gateway Hang/Crash
  # Explicitly tell Nginx where the new SimpleScalable services live.
  nginxConfig:
    customWriteUrl: "http://loki-write.observability-prd.svc.cluster.local:3100"
    customReadUrl: "http://loki-read.observability-prd.svc.cluster.local:3100"
    customBackendUrl: "http://loki-backend.observability-prd.svc.cluster.local:3100"

# --- MINIO (Embedded Storage) ---
minio:
  enabled: true
  rootUser: admin
  existingSecret: minio-creds
  persistence: { enabled: true, size: 10Gi }
  resources:
    requests: { memory: 256Mi }
    limits: { memory: 1Gi }
  buckets:
    - name: loki-chunks
      policy: none
    - name: loki-ruler
      policy: none
    - name: loki-admin
      policy: none
    - name: mimir-blocks
      policy: none
    - name: mimir-ruler
      policy: none
    - name: tempo-data
      policy: none

# Disable monitoring sidecars to save resources
monitoring:
  dashboards: { enabled: false }
  rules: { enabled: false }
  serviceMonitor: { enabled: false }
  selfMonitoring: { enabled: false, lokiCanary: { enabled: false } }