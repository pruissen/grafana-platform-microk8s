# k8s/values/loki.yaml
deploymentMode: SimpleScalable

global:
  extraEnvFrom:
    - secretRef:
        name: loki-s3-credentials

loki:
  auth_enabled: true 

  limits_config:
    max_query_series: 10000
    max_entries_limit_per_query: 10000
    cardinality_limit: 200000
    split_queries_by_interval: 15m 
    max_query_parallelism: 32

  commonConfig:
    replication_factor: 1
    ring:
      kvstore:
        store: memberlist
  storage:
    type: s3
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
      admin: loki-admin
    s3:
      endpoint: http://loki-minio.observability-prd.svc:9000
      s3ForcePathStyle: true
      insecure: true

  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: index_
          period: 24h

# --- ðŸš€ SCALABLE COMPONENTS (1 Replica Each for Local) ---

# 1. WRITE TARGET (Distributor + Ingester)
# Handles incoming logs and pushes to S3
write:
  replicas: 1
  persistence:
    size: 10Gi
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 2. READ TARGET (Query Frontend + Querier)
# Handles Grafana queries and caching
read:
  replicas: 1
  persistence:
    size: 10Gi # Used for cache
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 3. BACKEND TARGET (Ruler + Compactor + Index Gateway)
# Handles alert rules, retention, and index compaction
backend:
  replicas: 1
  persistence:
    size: 10Gi
  resources:
    requests: { cpu: 50m, memory: 256Mi }
    limits: { memory: 1Gi }

# 4. GATEWAY (Nginx)
gateway:
  replicas: 1
  ingress: { enabled: false }
  resources:
    requests: { cpu: 20m, memory: 64Mi }
    limits: { memory: 128Mi }

# --- MINIO (Embedded Storage) ---
# We keep this enabled to persist S3 data locally
minio:
  enabled: true
  rootUser: admin
  existingSecret: minio-creds
  persistence: { enabled: true, size: 10Gi }
  resources:
    requests: { memory: 256Mi }
    limits: { memory: 1Gi }
  buckets:
    - name: loki-chunks
      policy: none
    - name: loki-ruler
      policy: none
    - name: loki-admin
      policy: none
    - name: mimir-blocks
      policy: none
    - name: mimir-ruler
      policy: none
    - name: tempo-data
      policy: none

# Disable monitoring sidecars to save resources
monitoring:
  dashboards: { enabled: false }
  rules: { enabled: false }
  serviceMonitor: { enabled: false }
  selfMonitoring: { enabled: false, lokiCanary: { enabled: false } }