# k8s/values/alloy.yaml
alloy:
  extraPorts:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP

  rbac:
    create: true
    clusterRole:
      rules:
        - apiGroups: [""]
          resources: ["pods", "namespaces", "nodes", "services", "endpoints", "events", "nodes/proxy", "nodes/metrics", "nodes/spec"]
          verbs: ["get", "watch", "list"]
        - apiGroups: ["apps"]
          resources: ["replicasets", "daemonsets", "deployments", "statefulsets"]
          verbs: ["get", "watch", "list"]
        - nonResourceURLs: ["/metrics", "/metrics/cadvisor"]
          verbs: ["get"]

  # âœ… CRITICAL: Enable Host Network to access Kubelet/cAdvisor on localhost
  controller:
    type: DaemonSet
    hostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet
    resources: { requests: { cpu: 100m, memory: 256Mi }, limits: { memory: 1Gi } }

  configMap:
    content: |
      // ==============================================================================
      // 1. DISCOVERY SOURCES
      // ==============================================================================

      // 1.1 Kubelet Discovery (Used for finding Pods for Logs/Metadata)
      discovery.kubelet "local_pods" {
        url = "https://localhost:10250"
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        tls_config {
          insecure_skip_verify = true 
        }
      }

      // 1.2 Global Resource Discovery
      discovery.kubernetes "k8s_services" { role = "service" }
      discovery.kubernetes "k8s_nodes"    { role = "node" }

      // ==============================================================================
      // 2. SCRAPE TARGETS (Infrastructure)
      // ==============================================================================

      // --- 2.1 Kubelet (Node Stats) ---
      // Scrape localhost directly via hostNetwork
      prometheus.scrape "kubelet" {
        targets = [{
          __address__ = "localhost:10250",
          job         = "kubelet",
          instance    = env("HOSTNAME"), 
        }]
        forward_to = [prometheus.relabel.infra_enrich.receiver]
        scheme     = "https"
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        tls_config {
          insecure_skip_verify = true
        }
      }

      // --- 2.2 cAdvisor (Container Stats) ---
      prometheus.scrape "cadvisor" {
        targets = [{
          __address__ = "localhost:10250",
          job         = "cadvisor",
          instance    = env("HOSTNAME"),
        }]
        forward_to = [prometheus.relabel.infra_enrich.receiver]
        scheme     = "https"
        metrics_path = "/metrics/cadvisor"
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        tls_config {
          insecure_skip_verify = true
        }
      }

      // --- 2.3 Kube State Metrics ---
      discovery.relabel "ksm" {
        targets = discovery.kubernetes.k8s_services.targets
        rule {
          source_labels = ["__meta_kubernetes_service_label_app_kubernetes_io_name"]
          regex = "kube-state-metrics"
          action = "keep"
        }
      }
      prometheus.scrape "ksm" {
        targets    = discovery.relabel.ksm.output
        forward_to = [prometheus.relabel.infra_enrich.receiver]
        job_name   = "kube-state-metrics"
      }

      // --- 2.4 API Server ---
      discovery.relabel "apiserver" {
        targets = discovery.kubernetes.k8s_services.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_service_name"]
          regex = "default;kubernetes"
          action = "keep"
        }
      }
      prometheus.scrape "apiserver" {
        targets    = discovery.relabel.apiserver.output
        forward_to = [prometheus.relabel.infra_enrich.receiver]
        scheme     = "https"
        job_name   = "apiserver"
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        tls_config {
          ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          insecure_skip_verify = true
        }
      }

      // --- 2.5 Node Exporter ---
      prometheus.exporter.unix "node_metrics" { include_exporter_metrics = true }
      prometheus.scrape "node_infra" {
        targets    = prometheus.exporter.unix.node_metrics.targets
        forward_to = [prometheus.relabel.infra_enrich.receiver]
        job_name   = "node-exporter"
      }

      // --- 2.6 ArgoCD Metrics ---
      discovery.relabel "argocd" {
        targets = discovery.kubelet.local_pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex = "argocd-system"
          action = "keep"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          regex = "argocd-(server|application-controller|repo-server).*"
          action = "keep"
        }
        // Force Job Names for Dashboards
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          regex = ".*argocd-server.*"
          target_label = "job"
          replacement = "argocd-server-metrics"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          regex = ".*argocd-application-controller.*"
          target_label = "job"
          replacement = "argocd-controller-metrics"
        }
      }
      prometheus.scrape "argocd" {
        targets    = discovery.relabel.argocd.output
        forward_to = [prometheus.relabel.infra_enrich.receiver]
      }

      // ==============================================================================
      // 3. ENRICHMENT & OUTPUT (Infrastructure)
      // ==============================================================================

      // Add 'cluster' label to ALL metrics
      prometheus.relabel "infra_enrich" {
        forward_to = [prometheus.remote_write.infra.receiver]
        rule {
          action = "replace"
          replacement = "microk8s-local"
          target_label = "cluster"
        }
      }

      prometheus.remote_write "infra" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = { "X-Scope-OrgID" = "platform-k8s" }
        }
      }

      // ==============================================================================
      // 4. LOGS (Loki)
      // ==============================================================================
      
      loki.source.kubernetes_events "cluster_events" {
        job_name   = "integrations/kubernetes/eventhandler"
        forward_to = [loki.write.infra.receiver]
      }

      discovery.relabel "infra_logs" {
        targets = discovery.kubelet.local_pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          action = "drop"
          regex = "observability-prd|devteam-1"
        }
        // Multi-line syntax rules
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        rule {
          action = "replace"
          replacement = "microk8s-local"
          target_label = "cluster"
        }
      }
      
      loki.source.kubernetes "infra_pod_logs" {
        targets    = discovery.relabel.infra_logs.output
        forward_to = [loki.write.infra.receiver]
      }

      loki.write "infra" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          tenant_id = "platform-k8s"
        }
      }

      // ==============================================================================
      // 5. OBSERVABILITY STACK (Self-Monitoring)
      // ==============================================================================
      discovery.relabel "obs_pods" {
        targets = discovery.kubelet.local_pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex = "observability-prd"
          action = "keep"
        }
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
      }
      prometheus.scrape "obs_stack" {
        targets    = discovery.relabel.obs_pods.output
        forward_to = [prometheus.relabel.obs_enrich.receiver]
        scrape_interval = "30s"
      }
      prometheus.relabel "obs_enrich" {
        forward_to = [prometheus.remote_write.obs.receiver]
        rule {
          action = "replace"
          replacement = "microk8s-local"
          target_label = "cluster"
        }
      }
      loki.source.kubernetes "obs" {
        targets    = discovery.relabel.obs_pods.output
        forward_to = [loki.write.obs.receiver]
      }
      prometheus.remote_write "obs" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = { "X-Scope-OrgID" = "platform-obs" }
        }
      }
      loki.write "obs" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          tenant_id = "platform-obs"
        }
      }

      // ==============================================================================
      // 6. DEVTEAM-1 (Demo App)
      // ==============================================================================
      otelcol.receiver.otlp "default" {
        grpc { endpoint = "0.0.0.0:4317" }
        http { endpoint = "0.0.0.0:4318" }
        output {
          metrics = [otelcol.processor.batch.app.input]
          logs    = [otelcol.processor.batch.app.input]
          traces  = [otelcol.processor.batch.app.input]
        }
      }
      discovery.relabel "dev_pods" {
        targets = discovery.kubelet.local_pods.targets
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex = "devteam-1"
          action = "keep"
        }
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
      }
      loki.source.kubernetes "dev" {
        targets    = discovery.relabel.dev_pods.output
        forward_to = [loki.write.app.receiver]
      }
      otelcol.processor.batch "app" {
        output {
          metrics = [otelcol.exporter.prometheus.app.input]
          logs    = [otelcol.exporter.loki.app.input]
          traces  = [otelcol.exporter.otlp.app.input]
        }
      }
      otelcol.exporter.prometheus "app" {
        forward_to = [prometheus.remote_write.app.receiver]
      }
      otelcol.exporter.loki "app" {
        forward_to = [loki.write.app.receiver]
      }
      prometheus.remote_write "app" {
        endpoint {
          url = "http://mimir-nginx.observability-prd.svc:80/api/v1/push"
          headers = { "X-Scope-OrgID" = "devteam-1" }
        }
      }
      loki.write "app" {
        endpoint {
          url = "http://loki-gateway.observability-prd.svc:80/loki/api/v1/push"
          tenant_id = "devteam-1"
        }
      }
      otelcol.exporter.otlp "app" {
        client {
          endpoint = "tempo.observability-prd.svc.cluster.local:3100"
          headers = { "X-Scope-OrgID" = "devteam-1" }
          tls { insecure = true }
        }
      }